# ToR

ToR (**T**rust **o**n **R**elay chain): A Highly Scalable, General and Secure Cross-Chain Protocol.

## Setup on remote servers

The blockchains are deployed in a specified docker container, which has installed all required tools.

First, pull the specified image on each sever which will be used for running the blockchains.
```bash
docker pull tor_cc_env:latest
# The tor_cc_env is a customized image, which will be uploaded to docker hub later.
```

Next, start the container. The container uses ports `60000-60100/tcp` and `60000-60100/udp`.
```bash

ip=$(/usr/bin/hostname -I | awk '{print $1}')
sshport=60022
docker run -itd --env COLUMNS=800 --env LINES=100 -p 61000-60100:61000-60100/tcp -p 61000-60100:61000-60100/udp --name tor_cc tor_cc_env bash -c "\
echo HOSTIP=$ip >> /etc/environment && \
/scripts/start_ssh.sh $sshport \
"
```

## Setup on local machine

### install requirements

```bash
pip install -r requirements.txt
```

### start the JsonDB server

The JsonDB server is used for synchronizing system configs between different server and local machines.

First, start the JsonDB server in bash.
```bash
nohup python deploy_nodes/config_server/config_server.py --port 10051 --config_path ./config_db 2>&1 >config_server.log &
```

Second, set the ip and port in the `setting.py`
```python
CONFIG_DB_HOST = 'XXX.XXX.XXX.XXX' # ip of JsonDB server
CONFIG_DB_PORT = 10051 # port of JsonDB
```

### initialize the blockchain and server configurations

There are three configuration ctypes, including `server.json`, `transfer.json`, `blockchain-xxx.json`, in the directory `deploy_nodes/init_config`. The configuration `blockchain-xxx.json` is created dynamically by `relayer/xxx/generate_configs.py`, so it cannot be seen in that directory before creating.

1. `server.json `

It includes the server ip, port, ssh-username, ssh-password of the blockchain container on servers.

It is used for generating the `blockchain-XXX.json` in which servers' ip/port is from here.

```json
[
    {
        "host": "XXX.XXX.XXX.XXX",
        "port": "60022", // it is fixed in the container running script.
        "username": "root", // it is fixed in the container running script.
        "password": "ttfgCbowIy14eZay", // it is fixed in the container running script.
        "send": true
    }
]
```

2. `transfer.json` 

A config for transporting the required binaries (blockchain, solc, etc.) and scripts to the remote servers.

It specifies the relevant file paths.

```json
{
    "local_files": "./blockchain", // 本地需要压缩打包的文件夹路径
    "local_tar": "./deploy_nodes/deploy/blockchain.tar", // 打包之后待发送的文件路径
    "remote_tar": "/root/workspace/blockchain.tar", // 发送到区块链节点容器的目的文件路径
    "remote_files": "/root/workspace/blockchain", // 区块链节点容器中目的文件解压后的路径
    "cache_pid_dir": "/root/workspace/cache_pid" // 区块链节点容器中程序的进程id，主要用于kill远程进程
}
```

3. `blockchain-xxx.json`

Blockchains' configurations are written in this file.

It is generated by `relayer/xxx/generate_configs.py`.

### deploy blockchains

```bash
# 初始化jsonDB数据库，其实就是将init_config文件夹下的json文件复制到config_db目录下
# initialize the JsonDB config, which copy the config files in `deploy_nodes/init_config` to `/`.
# and send required files to those remote server.
python deploy_nodes/deploy/initialize_config.py
python deploy_nodes/deploy/0_gzip.py
python deploy_nodes/deploy/1_send_tar.py

# generate blockchainc configs
# --paranum: number of blockchains
# the generated config files is in `c`
python relayer/aor/generate_configs.py --paranum 3
# >> bash output >> blockchain_aor_3
# get the output which is the config name (for example: blockchains_aor_3)

# start chains with the same config name (for example: blockchains_aor_3)
python deploy_nodes/deploy/4_0_start_parallel_chain.py --config_name blockchains_aor_3

# deploy contracts with the same config name (for example: blockchains_aor_3)
python contracts/deploy.py --config_name blockchains_aor_3

# start all gateways with the same config name (for example: blockchains_aor_3)
python relayer/aor/scheduler.py --config_name blockchains_aor_3

# stop all chains with the same config name (for example: blockchains_aor_3)
python deploy_nodes/deploy/stop_remote_geth.py --config_name blockchains_aor_3
```