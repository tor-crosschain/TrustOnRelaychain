# ToR: A Highly Scalable, General and Secure Cross-Chain Protocol

> *The supplement material is in [supplements/supplement-material.pdf](supplements/supplement-material.pdf).*

> This repository covers ToR deployed on Ethereum for realistic evaluations.
> The simulator version is in another repository [TrustOnRelaychain-Simulator](https://github.com/tor-crosschain/TrustOnRelaychain-Simulator)

## Core modules

The ToR protocol implementation's core modules include:

1. on-chain contract: `./contracts/`. This contract integrates all functionalities of ToR, AoR and NoR.
2. off-chain gateway:
   - ToR: `./relayer/tor/`
   - AoR: `./relayer/aor/`
   - NoR: `./relayer/nor/`

We deploy the cross-chain system on remote servers and execute deployment commands on the local machine. Therefore, in the following parts, firstly we describe how to setup on remote servers, secondly how to setup on local machine, and finally how to reproduce the evaluating results for Microbench in our paper $\S 7.4$.

## Setup on remote servers

The blockchains are deployed in a specified docker container, which has installed all required tools.

First, pull the specified image from docker hub and put it on each sever which will be used for running the blockchains.

```bash
docker pull trustonrelaychain/tor_cc_env:latest
```

Next, start the container on each server. The container uses ports `60000-60100/tcp` and `60000-60100/udp`.

```bash

ip=$(/usr/bin/hostname -I | awk '{print $1}')
sshport=60022
docker run -itd --env COLUMNS=800 --env LINES=100 -p 61000-60100:61000-60100/tcp -p 61000-60100:61000-60100/udp --name tor_cc tor_cc_env bash -c "\
echo HOSTIP=$ip >> /etc/environment && \
/scripts/start_ssh.sh $sshport \
"
```

## Setup on local machine

### install requirements

```bash
pip install -r requirements.txt
```

### start the JsonDB server

The JsonDB server is used for synchronizing system configs between different server and local machines.

First, start the JsonDB server in bash.

```bash
nohup python deploy_nodes/config_server/config_server.py --port 10051 --config_path ./config_db 2>&1 >config_server.log &
```

Second, set the ip and port in the `setting.py`

```python
CONFIG_DB_HOST = 'XXX.XXX.XXX.XXX' # ip of JsonDB server
CONFIG_DB_PORT = 10051 # port of JsonDB
```

### initialize the blockchain and server configurations

There are three configuration ctypes, including `server.json`, `transfer.json`, `blockchain-xxx.json`, in the directory `deploy_nodes/init_config`. The configuration `blockchain-xxx.json` is created dynamically by `relayer/xxx/generate_configs.py`, so it cannot be seen in that directory before creating.

1. `server.json `

It includes multiple containers' configs. For each container, the config covers ip, port, ssh-username, ssh-password.

It is used for generating the `blockchain-XXX.json` in which servers' ip/port is from here.

```json
[
    {
        "host": "1.1.1.1",
        "port": "60022", 
        "username": "root",
        "password": "ttfgCbowIy14eZay",
        "send": true
    }
]
```

The property `port`, `username`, `password` all have been fixed in the container running script. DONT alter them. Only change the `host`.


2. `transfer.json`

A config for transporting the required binaries (blockchain, solc, etc.) and scripts to the remote servers.

It specifies the relevant file paths and it cannot be changed.

```json
{
    "local_files": "./blockchain", 
    "local_tar": "./deploy_nodes/deploy/blockchain.tar", 
    "remote_tar": "/root/workspace/blockchain.tar", 
    "remote_files": "/root/workspace/blockchain", 
    "cache_pid_dir": "/root/workspace/cache_pid" 
}
```

3. `blockchain-xxx.json`

Blockchains' configurations are written in this file.

It is generated by `relayer/xxx/generate_configs.py`.

4. `parallel_chain.json`

The `parallel_chain.json` is used for reproducing the Microbench evaluations for on-chain cost, especially for BCR constructing algorithm $A_{BCR}^u$.

The file covers multiple blockchains' configs. For each blockchain, the config covers `chain_name`, `chain_type` and `bootnode`, `server_nodes`. For `server_nodes`, it could cover multiple nodes, and each node is deployed in a container. The `host`, `port` in `server_nodes` represents the container's ssh host and port.

```json
[
    {
        "chain_name": "parallel_chain_1",
        "chain_type": "eth-pow",
        "bootnode": {
            "host": "1.1.1.1",
            "port": "60022",
            "username": "root",
            "password": "ttfgCbowIy14eZay",
            "bootnode_key": "parallel_chain_1_bootnode"
        },
        "server_nodes": [
            {
                "host": "1.1.1.1",
                "port": "60022",
                "username": "root",
                "password": "ttfgCbowIy14eZay"
            }
        ]
    }
]
```

## Reproduce the Microbench Evaluations

### For Realistic On-chain Cost

This part reproduces the evaluation results in paper $\S 7.4.2$.

**1. deploy blockchains**

```bash
# initialize the JsonDB config, which copy the config files in `deploy_nodes/init_config` to `/`.
# and send required files to those remote server.
python deploy_nodes/deploy/0_initialize_config.py
python deploy_nodes/deploy/1_0_gzip.py
python deploy_nodes/deploy/1_1_send_tar.py

# generate blockchainc configs
# --paranum: number of blockchains
# the generated config files is in `config_db/blockchain_tor_3.json`
python relayer/tor/generate_configs.py --paranum 3
# >> bash output >> blockchain_tor_3
# get the output which is the config name (for example: blockchains_tor_3)

# start chains with the same config name (for example: blockchains_tor_3)
python deploy_nodes/deploy/4_0_start_parallel_chain.py --config_name blockchains_tor_3
```

**2. deploy contracts**

```bash
# deploy contracts with the same config name (for example: blockchains_tor_3)
python contracts/deploy.py --config_name blockchains_tor_3

# stop all chains with the same config name (for example: blockchains_tor_3)
python deploy_nodes/deploy/stop_remote_geth.py --config_name blockchains_tor_3
```

**3. run evaluations**

```bash
# run evaluations for ToR, the script includes the following parts:
# # (1) start gateways between all blockchains
# # (2) run evaluations with 1000 txs sent to each blockchain
# the result is in direcetory './info'
python relayer/tor/scheduler.py --config_name blockchains_tor_3

# after the ToR evaluation finishes, we could run evaluations for NoR and AoR
# python relayer/nor/scheduler.py --config_name blockchains_tor_3
# python relayer/aor/scheduler.py --config_name blockchains_tor_3

# NOTE: run each evaluation one by one, not parallelly.
```

After the evaluating finishes, we could stop the system.

```bash
# stop all chains with the same config name (for example: blockchains_tor_3)
python deploy_nodes/deploy/stop_remote_geth.py --config_name blockchains_tor_3
```

### For Performance of $A_{BCR}^u$

To evaluate the algorithm $A_{BCR}^u$, we pack the necessary contracts and scripts into the directoroy `./bcr`. We can easily run the following command to perform the evaluations. The argument `method` could take `null`, `BCR`, `UpdateByLeaves` and `UpdateByTree` as input.

Before run the command, we must alter the file `./bcr/setting.json` to change the `ip`, `host`, `port` of the server which holds containers.

```bash
# evaluate, and output results into directory `./bcr/result`
python ./bcr/executeByCross.py --method BCR
# generate figures to directory ./bcr/images
python ./bcr/plot.py
```
